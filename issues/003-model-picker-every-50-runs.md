# 发送前每 50 轮切换模型：点击发送按钮左侧打开模型弹窗并选下一项

**类型**: feature  
**优先级**: normal  
**预估工时**: medium  

---

## TL;DR

- 在发送区域：定位**发送按钮左侧相邻元素**并点击，打开模型选择弹窗（`role="dialog"`，内为 `role="menu"` + 多个 `role="menuitem"`）。
- 需**记录/识别当前选中的模型**；**每执行 50 次**（按全局 `totalDone` 计）后，在弹窗中切换到**下一个**模型；若已是列表最后一项，则选**第一项**。
- 切换完成后关闭弹窗（或点击选项后自动关闭），再继续原有的输入+发送流程。

---

## 当前状态 vs 期望结果

| 当前 | 期望 |
|------|------|
| 不打开模型选择器，直接输入+发送 | 每 50 轮（第 50、100、150… 轮）前：点击发送按钮左侧元素 → 弹窗出现 → 选「下一个」模型（末项则选第一项）→ 再执行本轮的输入+发送 |
| 无模型状态记录 | 能识别当前选中项（如通过弹窗内勾选/高亮），并据此计算「下一项」 |

---

## 需求细节

### 1. 定位并点击「发送按钮左侧相邻元素」

- 发送按钮选择器：现有 `[data-testid="agent-send-message-button"]`。
- 需定位该按钮在 DOM 中的**左侧相邻元素**（同一父容器内的前一个兄弟或布局上在其左侧的可点击元素），并执行点击。
- 实现方式建议：用 Playwright 先定位发送按钮，再取 `locator('xpath=preceding-sibling::*[1]')` 或父容器内按顺序取前一个可点击子元素；若布局是 flex 且顺序与 DOM 一致，前一个兄弟即左侧。

### 2. 弹窗结构（用户提供）

- 弹窗：`div[role="dialog"][aria-modal="true"]`。
- 内容：`div[role="menu"]`，其内多个 `div[role="menuitem"]`，对应模型选项（如 Auto、Claude Sonnet 4.5、Claude Opus 4.6、Gemini 3 Pro、GPT-5.2 等）。
- 当前选中项：从你提供的 HTML 看，某一项内包含 `class="checkmarkSmall"` 的 svg，可作为「当前选中」的识别方式；若无稳定 class，可用 `aria-selected` 或文案匹配辅助。

### 3. 记录当前模型与「每 50 次切换下一个」

- **记录/区分当前模型**：  
  - 方案 A：每次打开弹窗时，根据勾选/高亮/aria 确定当前选中的是第几个 `menuitem`（索引或文案）。  
  - 方案 B：脚本内维护一个「当前模型索引」（打开弹窗时若尚未初始化，则用弹窗内当前选中项初始化）。  
- **每执行 50 次**：以全局已执行轮数 `totalDone` 为准，当 `totalDone > 0` 且 `totalDone % 50 === 0` 时（即第 50、100、150… 轮**之前**），执行一次「打开弹窗 → 选下一项」。
- **下一项规则**：当前为列表第 `i` 项（从 0 起），则下一项为第 `(i + 1) % length` 项；即若当前为最后一项，则下一项为第一项。点击对应 `menuitem` 完成切换；若点击后弹窗自动关闭，则无需额外关弹窗。

### 4. 与主循环的衔接

- 在主循环中，在「本轮的输入+发送」之前判断：若 `totalDone > 0 && totalDone % 50 === 0`，则先执行「点击发送左侧 → 等待弹窗 → 识别当前项 → 点击下一项」；再执行原有的 `typeAndSend`。
- 首次运行（totalDone === 0）不切换，只从第 50 轮开始每 50 轮切换一次。

---

## 涉及文件

- `src/selectors.ts` — 新增：发送按钮左侧元素的定位方式（或通过发送按钮推导）；模型弹窗 `role="dialog"`、`role="menu"`、`role="menuitem"`；当前选中标识（如带 checkmark 的项）。
- `src/index.ts` — 主循环中增加「每 50 轮切换模型」逻辑；新增函数：打开模型弹窗（点击发送左侧）、解析当前选中项索引、点击第 n 个 menuitem；在 `typeAndSend` 前按条件调用。

---

## 风险与注意

- **DOM 结构**：Notion 为 SPA，菜单项顺序或 class 可能随版本变化；优先用 `role="menuitem"` 顺序 + 当前选中状态（勾选/aria）识别，避免依赖具体文案或 class 名。
- **时机**：点击发送左侧后需等待 `role="dialog"` 可见再操作菜单；点击 menuitem 后等待弹窗消失再继续，避免与输入框焦点冲突。
- **50 的边界**：第 50、100、150… 轮「之前」切换，即这 50 轮用的是上一轮选好的模型；切换后从下一轮开始用新模型。

---

## 验收要点

- [ ] 能稳定定位并点击「发送按钮左侧相邻元素」，且点击后出现模型选择弹窗。
- [ ] 能识别弹窗内当前选中的模型（如通过勾选或 aria）。
- [ ] 每执行 50 次（totalDone 为 50、100、150…）前，自动在弹窗中选「下一项」；最后一项的下一项为第一项。
- [ ] 切换完成后能继续正常执行本轮的输入与发送，且不影响 New AI chat、文案轮数等既有逻辑。
