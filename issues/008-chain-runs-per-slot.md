# 行业任务链：时段内执行次数（chainRunsPerSlot）

**类型**：feature  
**优先级**：normal  
**工作量**：medium

---

## TL;DR

在行业配置里增加一个变量，控制**当前执行时段内**完整任务链跑几轮：0 = 一直周期性重复（现行为），1 = 时段内只跑 1 轮完整链后等待到下一时段，2 = 跑 2 轮后等待，以此类推。

---

## 当前行为 vs 期望行为

| 项目 | 当前 | 期望 |
|------|------|------|
| 任务链跑完一轮后 | 立刻从头再跑，在时段内无限循环 | 由新变量控制：0=无限循环；≥1 时跑满 N 轮完整链后在本时段内不再执行，等待到下一时段（或未落入任何区间）再按新区段逻辑继续 |

**举例**（任务链：task1 → task2 → task3）：

- 设为 **1**：跑完 task1、task2、task3 算 1 次完整链，本时段内不再跑，等待到下一时段。
- 设为 **2**：跑完第一轮 task1→task2→task3 算 1 次，再跑一轮 task1→task2→task3 算 2 次，然后本时段内不再跑，等待到下一时段。
- 设为 **0**：与现在一致，时段内一直重复 task1→task2→task3。

---

## 涉及文件（建议）

| 文件 | 修改点 |
|------|--------|
| `src/schedule.ts` | `ScheduleIndustry` 增加 `chainRunsPerSlot: number`（0=无限）；校验非负整数；默认 0；旧配置兼容可默认 0 |
| `src/index.ts` | 主循环内：进入/切换行业时重置「本时段已跑链轮数」；每跑完一整轮任务链后 +1；若 `chainRunsPerSlot > 0` 且已跑满则进入「等待离开当前时段」（轮询 `getIndustryForNow`，直到不在当前行业或为 null），再继续外循环；同一行业下一时段再次落入时需重置「本时段已跑轮数」 |
| `src/server.ts` | 行业编辑弹窗：增加「时段内跑几轮任务链」输入（0=一直跑）；`openEditModal` 回填、`saveEditModal` 收集并写入 `chainRunsPerSlot` |
| `schedule.example.json` | 示例行业里增加 `chainRunsPerSlot: 0` 注释或示例 |

---

## 实现要点（简要）

- **计数粒度**：以「完整一轮任务链」（task1…taskN 按顺序各执行完自己的 `runCount`）为 1 次。
- **等待语义**：「跑满 N 轮后等待」= 在本时段内不再启动新的一轮，循环检查当前时间所在区间，直到离开当前时段（`getIndustryForNow()` 变为另一行业或 null），再继续主循环（可能切行业或等区间）。
- **重置时机**：切换行业时重置「本时段已跑轮数」；从「等待离开时段」后再次落入**同一**行业（例如次日同一时段）时，也应视为新区段，重置该计数。

---

## 风险与备注

- 与现有「任务链跑完立刻从头再跑」的兼容：`chainRunsPerSlot === 0` 或未配置时保持现行为。
- 若时段很长且设为 1，跑完一轮后会长时间轮询等待；可考虑用较长 sleep（如 1 分钟）再检查，避免 CPU 空转。
