# Issue 009 补充探索：对话结束后才出现的按钮（如 Delete pages）

## 1. 问题场景

- **现状**：在「等待输出结束」的轮询里，**一旦检测到发送按钮可见就立即 return**，不再检测、也不再点击配置的按钮。
- **实际情况**：有时「Delete pages」等按钮会在**对话已经结束（发送按钮已出现）之后**才弹出，此时我们已经退出等待循环，进入「新一轮」或下一轮发送前的状态，**从未对这类按钮做匹配和点击**。
- **结果**：配置了自动点击也不生效，需要人工点掉。

## 2. 根因

- 当前逻辑是「先判断发送按钮 → 可见则立刻结束等待」。
- 若 Notion 先恢复发送按钮，再在几百毫秒或几秒后弹出「Delete pages」，我们的循环已经结束，后续不再有机会检测该按钮。

## 3. 可选优化方向

### 方案 A：等待结束后做「事后清扫」（post-wait sweep）

- **思路**：`waitForSendButtonWithAutoClick` 仍保持「发送按钮可见即 return」。在 **typeAndSend 里，在 wait 成功返回之后**，再执行一段**固定时长/固定次数的清扫**：只检测配置的按钮是否可见，可见则点击，不依赖发送按钮状态。
- **实现要点**：
  - 新增例如 `sweepAutoClickButtons(page, buttonNames, { durationMs?: number, intervalMs?: number })`：在指定时长内按间隔轮询，每次只按配置顺序查按钮、可见则点击；不查发送按钮、不抛错。
  - 在 `typeAndSend` 中，`await waitForSendButtonWithAutoClick(...)` 成功后，若 `buttonNames.length > 0`，再 `await sweepAutoClickButtons(page, buttonNames, { durationMs: 5000, intervalMs: 1000 })`（参数可配置或写死）。
- **优点**：职责清晰——「等待结束」与「事后清扫」分离；不改变现有超时与重试语义。能覆盖「对话已结束、稍后才弹出按钮」的情况。
- **缺点**：每次发送后多几秒的清扫时间（可接受，且可做成可配置或较短默认值）。

### 方案 B：在等待循环内「即将 return 前」多扫几轮

- **思路**：当某次轮询发现发送按钮可见时，**不立即 return**，而是先做 N 次（如 2～3 次）「只查配置按钮并点击」的迭代（每次间隔约 1s），再 return。
- **实现要点**：在 `waitForSendButtonWithAutoClick` 里，在 `if (await sendBtn.isVisible()...) return;` 之前或改为：若发送按钮可见，进入一个 2～3 次的小循环，只执行「按 buttonNames 顺序检测并点击」，然后 return。
- **优点**：不增加新函数，逻辑集中在一处。
- **缺点**：混合了「等待结束」与「收尾清扫」两种语义，且清扫轮数固定，若按钮出现再晚一点仍可能漏掉；扩展为「可配置清扫时长」时不如方案 A 直观。

### 方案 C：每轮先扫配置按钮，再判断发送按钮

- **思路**：轮询时**先**按配置顺序检测并点击按钮，**再**判断发送按钮是否可见；若可见则 return。
- **效果**：只能解决「发送按钮与 Delete pages 同时或几乎同时出现」的情况；若按钮在**我们 return 之后**才出现，仍然不会点击。
- **结论**：对「对话已经结束后才出现按钮」**无效**，仅可作为小优化保留现有顺序或微调顺序，不单独采用。

## 4. 建议

- **采用方案 A**：在 `typeAndSend` 中，`waitForSendButtonWithAutoClick` 成功返回后，若配置了 `buttonNames`，再执行一次**事后清扫**（例如 3～5 秒内、每秒一轮，只检测并点击配置的按钮）。
- **参数**：清扫时长、间隔可先写死（如 5s、1s），与现有 `AUTO_CLICK_POLL_MS` 风格一致；若后续需要可再提到 schedule 或 config。
- **边界**：清扫阶段不抛错（点击失败只打日志），不延长「等待输出结束」的主超时（清扫是额外步骤，主超时已结束）。

## 5. 待确认（可选）

- 事后清扫的**默认时长**是否 3～5 秒即可，还是希望更长（例如 10 秒）？
- 是否需要在 schedule 或 UI 中暴露「事后清扫时长/轮数」配置，还是先写死简单实现？

## 6. 已确认规格（产品拍板）

- **清扫时长**：**5 秒**，写死即可。
- **是否可配置**：**写死**，不暴露到 schedule 或 UI。
- **实现**：方案 A，`sweepAutoClickButtons(page, buttonNames)` 内部使用 `durationMs = 5000`、`intervalMs = 1000`（5 轮清扫），写死在代码常量中；`typeAndSend` 在 wait 成功后、若 `buttonNames.length > 0` 则调用一次。

确认后即可按方案 A 实现并接入 `typeAndSend`。
