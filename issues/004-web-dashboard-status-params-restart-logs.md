# Web 控制台：查看运行状态、编辑参数、重启脚本与最近 10 次运行日志

**类型**: feature  
**优先级**: normal  
**预估工时**: large  

---

## TL;DR

- **新增命令**（如 `npm run dashboard`）启动 Web 服务；首次打开页面时脚本**未运行**。页面可查看运行状态（运行中/已停止）、编辑参数（持久化到 **params.json**）、**停止/启动**脚本、查看最近 10 次运行日志（内存保留，不落盘）。
- 约束：**仅 notion-auto 子进程被停止/启动；Web 服务进程保持运行。** 端口固定 9000，仅 localhost。

---

## 约定（已澄清）

- **启动方式**：新增命令（如 `npm run dashboard`）启动 Web 服务；**首次打开页面时脚本处于未运行状态**，需用户点「启动」才会跑。
- **参数持久化**：页面提交的参数写入 **`params.json`**（项目目录下）；服务启动时加载该文件作为表单默认值（若不存在则用 CLI 默认）。
- **日志**：**不落盘**，仅内存保留；能在页面看到「当前运行」及「最近 10 次运行」的日志即可，服务重启后历史清空。
- **停止与启动**：提供 **「停止」** 和 **「启动」** 两个操作（启动时使用当前表单参数；若在运行中可先停止再改参数再启动）。
- **prompt-gateway**：保留该参数，**必填**（有值时才视为使用 gateway）；若使用则忽略 task1/2/3，与 CLI 行为一致。
- **storage**：**不在页面暴露**，固定使用默认值（如 `.notion-auth.json`），不允许在 UI 配置。
- **运行状态**：首版只做 **「运行中 / 已停止」** 二态，不做当前轮数/总轮数等。
- **端口与访问**：**固定端口 9000**，**仅监听 localhost**。

---

## 当前状态 vs 期望结果

| 当前 | 期望 |
|------|------|
| 仅 CLI 启动（`npm run run -- --total 25 ...`），无 Web 界面 | 本地起一个 Web 服务，打开页面即可查看状态、改参数、重启脚本、看日志 |
| 参数仅能通过命令行传入，改参数需停进程再重新执行 | 在页面上编辑参数（持久化到 params.json），可「停止」/「启动」脚本，启动时以当前参数 spawn 子进程 |
| 日志只在终端输出，无历史 | 页面展示最近 10 次运行的日志（内存保留，不落盘），便于排查 |

---

## 需求细节

### 1. 运行情况查看

- 页面展示**当前运行状态**：仅「运行中 / 已停止」二态（首版不做轮数/总轮数等）。

### 2. 参数编辑与停止/启动

- 页面上可编辑与 CLI 对应的参数：`--total`、`--interval`、`--notion-url`、`--new-chat-every`、`--model-switch-interval`、`--prompt-gateway`（必填）、`--task1`/`--task2`/`--task3`（当使用 prompt-gateway 时被忽略）。**不暴露 `--storage`**，固定使用默认值。
- 参数变更写入 **params.json**；服务启动时加载 params.json 作为表单默认值。
- 提供 **「停止」**：终止当前 notion-auto 子进程（若有），不重启 Web 服务。
- 提供 **「启动」**：以当前表单参数 spawn notion-auto 子进程；若已在运行则需先停止再启动以应用新参数。

### 3. 最近 10 次运行日志

- 展示**最近 10 次**「脚本运行」的日志（每次运行一段日志；若某次运行尚未结束，则显示该次当前已有输出）。**仅内存保留，不落盘**；服务重启后历史清空。

### 4. 架构与部署约束

- **服务不重启**：承载 Web 页面的进程长期运行；只有 notion-auto **脚本进程**会被停止/启动。
- **入口**：新增命令（如 `npm run dashboard`）仅启动 Web 服务；首次打开页面时脚本**未运行**。
- **端口**：**固定 9000**；**仅监听 localhost**。
- 主进程 = Web 服务 + 子进程管理；子进程 = `tsx src/index.ts ...`；启动 = spawn 子进程并传入当前参数（来自表单/params.json）；停止 = kill 子进程。

---

## 涉及文件/模块（建议）

- **新增**：Web 服务入口（如 `src/server.ts`）、API（状态、参数读写 params.json、停止/启动子进程、日志）；前端页面（表单 + 停止/启动 + 日志区）。
- **新增**：`params.json` 的读写（参数持久化）；子进程 stdout/stderr 采集，按「运行」聚合，保留最近 10 次（仅内存）。
- **现有**：`src/config.ts` — 需能根据「页面/params 键值」组装出与 CLI 等价的参数列表（不含 --storage），供 spawn 使用。

---

## 风险与备注

- **进程模型**：脚本内若有关闭浏览器、退出进程的逻辑，需确保只结束「子进程」而非 Web 服务进程；建议将「可执行入口」与「CLI 入口」分离，或通过环境变量区分「被 Web 服务 spawn」与直接运行。
- **日志存储**：最近 10 次运行若每次很长，需做大小/条数裁剪，避免内存占用过大；可先限制为「最近 10 次运行 + 每次最近 N 行」。
- **安全**：固定端口 9000、仅监听 localhost，不暴露公网；本地使用即可。
