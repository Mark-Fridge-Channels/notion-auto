# 时间区间切换行业 + 行业任务链配置

**类型**: feature  
**优先级**: normal  
**预估工时**: large  

---

## TL;DR

- **时间区间调度**：支持按小时区间配置「哪个时间段跑哪个行业」，例如 1–5 点跑行业 A、5–10 点跑行业 B、10–15 点跑行业 C，最多可配置覆盖 24 小时。区间**左闭右开**，使用**系统本地时区**。**未配置的时间段不跑**（空闲等待）。
- **行业**：每个行业有独立 Notion URL + **任务链**（可增删改任务）。任务仅定义：**输入内容**、**执行次数**（该任务在本轮任务链中执行几次）。**新会话 / 换模型**为**行业级**配置：每跑 N 次（任意任务的每次执行计为 1 次）后新会话、每跑 M 次后换模型；例如 task1 跑 1 次、task2 跑 1 次即累计 2 次。
- **运行方式**：7×24 无限跑，仅用户手动停止时退出；同一时间区间内任务链跑完后**立刻从头循环**该行业任务链。**恢复**：按当前时间区间对应的行业恢复，且**从任务 1 重新开始**（不恢复任务进度）。
- **每轮间隔**：`intervalMs` 全局统一，所有行业/任务共用同一间隔。
- **模式**：只保留「时间区间 + 行业」模式，不做简单模式切换。

---

## 当前状态 vs 期望结果

| 当前 | 期望 |
|------|------|
| 全局单一 `notionUrl`，所有轮次同一页面 | 按时间区间选择「行业」，每个行业有独立 Notion URL |
| 全局三条 Task 文案（task1/2/3）或 prompt-gateway，按轮数/随机选 | 每个行业有**任务链**：多个任务可配置，每任务有「输入内容、执行次数、何时新会话、何时换模型」 |
| 全局 `newChatEveryRuns`、`modelSwitchInterval` | **行业级**：每跑 N 次后新会话、每跑 M 次后换模型（「次数」为任务链上每次执行的累计） |
| 无时间维度，启动后一直跑同一套逻辑 | 运行过程中根据当前时间落入的区间自动切换行业（及对应 URL、任务链） |

---

## 需求细节

### 1. 时间区间 → 行业

- 可配置多个**时间区间**（例如 01:00–05:00、05:00–10:00、10:00–15:00 …），每个区间绑定一个**行业**。
- **时间区间左闭右开**：例如 [01:00, 05:00) 含 01:00、不含 05:00，整点 05:00 归属下一区间；实现时按此约定判断「当前时间是否落在某区间内」。
- **时区**：使用**系统本地时区**（运行环境本地时间）解析当前时间与区间，不配置单独时区。
- 时间区间不重叠、可拼接，最多覆盖 24 小时；当前时间落在某区间内则使用该区间对应的行业配置。
- **未配置的时间段**：不跑（空闲等待，直到当前时间落入某已配置区间）。

### 2. 行业

- 每个行业包含：
  - **Notion URL**（必填）
  - **任务链**：有序任务列表，可新增、删除、编辑。
  - **行业级**：**每跑 N 次后新会话**、**每跑 M 次后换模型**（N、M 为自然数；0 表示不换模型）。「次数」= 该行业任务链上**每次执行**的累计（例如 task1 执行 1 次、task2 执行 1 次 = 2 次）。

### 3. 任务链与任务

- **任务**仅包含：
  - **输入内容**：该任务要输入到 Notion 的文案。
  - **执行次数**：该任务在本轮任务链中执行几次（每轮任务链从 task1 到最后一个 task 顺序执行，每个 task 跑满其执行次数后进入下一个 task）。
- 新会话、换模型由**行业级**配置统一控制（见上），不在单个任务上配置。
- 任务链按顺序执行；当前任务跑满「执行次数」后进入下一个任务；**任务链全部跑完后，立刻从头再跑该行业任务链**（同一时间区间内循环），直到时间落入下一区间则切换行业。

### 4. 每轮间隔与全局参数

- **每轮间隔 `intervalMs`**：全局统一，所有行业、所有任务共用同一间隔（与现有 `--interval` 一致，单位秒或毫秒由实现定）。
- 其他全局参数：如 `loginWaitMs`、`storagePath`、`maxRetries` 等仍为全局，与行业无关。

### 5. 配置形态与模式

- **只保留「时间区间 + 行业」模式**，不做简单模式切换；现有「单 URL + task1/2/3」的扁平配置由新结构完全替代。
- 配置需持久化（如 JSON 文件或现有 params.json 扩展）；CLI/Web 需能编辑时间区间、行业列表、每个行业的 URL、任务链及行业级「每 N 次新会话 / 每 M 次换模型」、全局 interval 等。
- 若已有 Web 控制台（见 issue 004），需在页面上支持：时间区间列表、行业列表、每个行业的 URL、新会话/换模型参数、任务链编辑（增删改任务及输入内容、执行次数）、全局间隔等。
- **页面布局与分块**（见下方「Dashboard 布局与分块」小节）：实现时可参考现有控制台的分块方式，对新配置做清晰分区。

---

## 相关文件（建议涉及）

- `src/config.ts` — 扩展配置结构：时间区间、行业、Notion URL、任务链及任务字段。
- `src/index.ts` / `src/dashboard-runner.ts` — 主循环：按当前时间解析「当前行业」与任务链，按任务执行次数与新会话/换模型规则驱动。
- `src/prompts.ts` — 任务链中「输入内容」可能仍复用或替换现有 getPromptForRun 逻辑。
- `src/model-picker.ts` — 与「第几次切换模型」挂钩。
- 若存在 `params.json` / dashboard 相关前端 — 新增时间区间与行业任务链的编辑 UI 与持久化。

---

## 风险与备注

- **时间边界**：已约定**左闭右开**（如 5:00 属 [05:00, …) 区间，不属于 [01:00, 05:00)）。
- **跨天与空闲时段**：24 点与 0 点的衔接按左闭右开处理（如 [22:00, 24:00) 与 [0:00, 6:00) 等）；未覆盖时段已约定为不跑。
- **与现有 CLI 的兼容**：本需求只保留时间区间+行业模式，现有扁平配置将被新结构替代，迁移时需提供默认或示例配置。
- **进度与恢复**：恢复时按**当前时间**所在区间得到当前行业，**从该行业任务 1 重新开始跑**（不恢复任务索引或任务内计数），仅用 `completed: false` 等驱动自动重启即可。

---

## 探索与已确认决策（Explore — 已澄清）

### 1. 对现有代码的理解（供实现时对照）

- **运行入口**：`src/index.ts` 主循环以 `totalDone < config.totalRuns` 为条件，每轮根据 `conversationRuns >= config.newChatEveryRuns` 点 New chat、根据 `totalDone % modelSwitchInterval === 0` 调 `switchToNextModel`，文案来自 `promptGateway` 或 `getPromptForRun(runIndex, task1, task2, task3)`。
- **配置来源**：CLI `parseArgs()` → `Config`，或 Dashboard 的 `params.json` → `DashboardParams` → `paramsToArgv()`；新需求下将改为「时间区间 + 行业 + 任务链」结构，仅保留此一种模式。
- **进度**：`progress.json` 当前存 `totalDone`、`conversationRuns`、`completed`；新模式下恢复不依赖任务进度，仅需 `completed: false` 等驱动自动重启，恢复时按当前时间区间得到行业并从任务 1 开始。

### 2. 已确认的 6 条决策

| # | 问题 | 确认结果 |
|---|------|----------|
| 1 | 结束条件 | **7×24 无限跑**，仅用户手动点击停止时退出；无总轮数。 |
| 2 | 任务链跑完后（同一时间区间内） | **立刻从头再跑该行业任务链**，循环跑任务链。 |
| 3 | 新会话/换模型语义 | **行业级**：每执行该行业任务链上的 **N 次**（任意任务的每次执行计 1 次）**之后**新会话；每 **M 次之后**换模型。例：行业 A 有 5 个 task，每个 task 跑 1 次，则 task1、task2 各跑 1 次 = 累计 2 次，若 N=2 则这两次后新会话。 |
| 4 | 未配置的时间段 | **不跑**（空闲等待，直到当前时间落入某已配置区间）。 |
| 5 | 简单模式 | **不需要**；只保留「时间区间 + 行业」模式，现有扁平配置由新结构替代。 |
| 6 | 恢复 | 按**当前时间区间**对应的行业恢复，并**从任务 1 重新开始跑**（不恢复任务索引或任务内计数）。 |

### 3. 最终流程（无歧义）

1. **启动 / 恢复**：取当前时间 → 解析所在时间区间 → 得到当前行业。若当前时间**未落入任何区间**则**不跑**（循环等待直到落入某区间，例如 sleep 到下一整点再检查）。
2. **进入行业**：取该行业 Notion URL、任务链、行业级「每 N 次新会话」「每 M 次换模型」。若当前页面 URL ≠ 行业 URL，则 `page.goto(industryUrl)`（并处理登录态）。初始化本行业**累计执行次数** = 0（用于新会话/换模型判断）。
3. **执行任务链（单轮）**：从任务 1 开始，按顺序执行每个任务：  
   - 该任务有「执行次数」K，则对该任务的「输入内容」执行 K 次 typeAndSend。每次执行前：若 `累计执行次数 > 0 且 累计执行次数 % N === 0` 则 New chat；若 `累计执行次数 > 0 且 累计执行次数 % M === 0` 则 switch model；然后 typeAndSend；累计执行次数 +1；interval 等待。  
   - 当前任务跑满 K 次后进入下一个任务，直到任务链最后一个任务跑完。
4. **任务链跑完**：立刻从任务 1 重新开始（回到步骤 3），不切换行业。
5. **每轮开始前（或每隔一次循环）检查时间**：若当前时间落入**另一时间区间**，则切换行业 → 更新 URL、任务链、N/M，若 URL 变化则 goto；累计执行次数重置；从该新行业的任务 1 开始执行（回到步骤 3）。
6. **停止**：仅由用户点击停止（或进程终止）结束，无总轮数退出。

**恢复**：进程重启后，用当前时间重算当前行业，从该行业任务 1 开始，不恢复「上次跑到第几个任务、第几次」。Progress 仅需支持自动重启判定（如 `completed: false`），无需存任务索引或任务内计数。

### 4. 与现有实现的差异小结

- **无 totalRuns**：主循环条件改为「永远跑，直到用户停止」；未配置时间段时为「等待 + 再检查时间」。
- **URL / 文案 / 新会话 / 换模型**：全部由「当前时间 → 行业 → 任务链 + 行业级 N/M」驱动，现有 Config/DashboardParams 的对应字段由新配置结构替代。
- **新会话/换模型**：按**行业级**「每 N 次 / 每 M 次」（任务链上每次执行累计），不再按「每 N 轮」全局计数。
- **任务**：仅「输入内容 + 执行次数」，无 per-task 新会话/换模型。
- **Resume**：不恢复任务进度，只按当前时间区间与行业从任务 1 开始。
- **intervalMs**：全局统一，见需求细节 4。

---

## 实现与代码层面注意点（供开发对照）

以下为探索阶段识别的实现细节与边界情况，实现时需逐一考虑，必要时在设计中约定或与产品确认。

### 配置与数据格式

- **时间区间表示**：具体格式（如 `"01:00-05:00"` 字符串，或 `startHour`/`endHour` 0–23）由实现定；**整点归属已约定**：**左闭右开**，例如 [1, 5) 含 1 点不含 5 点，5:00 属下一区间。
- **时区**：已约定使用**系统本地时区**（运行环境本地时间），不配置单独时区。
- **行业与时间区间绑定**：时间区间如何引用行业（行业 ID 字符串 vs 数组下标）；配置校验：至少一个时间区间、每行业至少一个任务、URL 非空等。

### 入口与启动

- **未配置时段**：启动时若当前时间不在任何区间，应先「等待再检查」再打开浏览器（避免先 goto 再空转）；等待策略如 sleep 到下一整点再解析区间，或每 N 秒检查一次，需约定。
- **无任何时间区间**：若配置中时间区间列表为空，应视为配置错误（报错退出或拒绝启动），避免死循环等待。
- **首次登录**：多行业共用同一 Notion 域名时，首次 goto 任一行业 URL 后做一次 loginWait 即可；切行业时仅 `page.goto(industryUrl)`，无需再次登录等待。

### 何时检查时间切行业

- 建议在**每一轮 typeAndSend 之前**（或至少每一轮任务链开始前）根据当前时间解析「当前行业」；若与当前运行行业不一致则切换（更新 URL、任务链、N/M，必要时 goto），避免整段时间跑错行业。

### 进度与恢复 / Dashboard

- **progress.json**：新模式下可不持久化 totalDone/conversationRuns，仅保留 `completed: false` 表示「运行中」以配合 Dashboard 自动重启；用户点击停止时由 Dashboard 设 `userWantsRunning=false`，不依赖 progress.completed。
- **Dashboard 启动方式**：当前为 `paramsToArgv(DashboardParams)` 传参；新结构下配置可能改为单文件（如 schedule.json），子进程改为读取该文件（如 `--config schedule.json` 或默认路径），Dashboard 仅需保证该文件存在并可编辑，无需再拼扁平 argv。需与现有「启动/停止/自动重启」逻辑兼容。

### 行业级 N/M 边界

- **N=0**：若允许「从不新会话」，需约定 N=0 表示不新会话；否则 N 最小为 1。**M=0**：已约定表示不换模型。
- **首轮**：第一次 typeAndSend 前 runCount=0，不触发新会话/换模型；从第二次执行前开始按 `runCount % N === 0` / `runCount % M === 0` 判断（与需求「每执行 N 次**之后**」一致）。

### 其他

- **空任务链**：某行业任务链为空数组时，应配置校验报错或运行时跳过该行业并打日志，避免空转。
- **openNotionAI / 复用逻辑**：现有 `openNotionAI(page, config)` 内部会 `page.goto(config.notionUrl)`；新模式下需传入当前行业 URL（或从当前行业对象取），避免仍用单一 config.notionUrl。

---

## Dashboard 页面布局与分块（现状与建议）

### 当前实现（`src/server.ts`）

- **无单独布局文档**：页面结构直接内联在 `getIndexHtml()` 的 HTML 字符串中，通过 CSS 与 class 分块。
- **整体结构**：
  1. **Header（.header）**：标题「notion-auto 控制台」+ 状态徽章（运行中/已停止）+ 操作区（启动、停止、保存参数）+ 参数错误提示。
  2. **主内容区（.layout）**：CSS Grid 两列（`grid-template-columns: 1fr 1fr`），≤768px 时单列。
     - **Card 1**：**运行设置**（总轮数、每轮间隔、登录等待、Notion URL、每 N 轮新会话、每 N 轮换模型、最大重试）。
     - **Card 2**：**文案设置**（Prompt 网关、Task 1/2/3）。
     - **Card 3（.logs-card, grid-column: 1 / -1）**：**最近运行日志**（Tab 切换各次运行 + 日志内容区），占满整行。
- **分块约定**：每块为 `.card`，标题用 `h2`；表单项用 `.row` + `label` + `input/textarea`；日志区单独样式 `.logs`。

### 新配置（时间区间 + 行业 + 任务链）的布局建议

- **延续现有风格**：继续使用 `.layout` + `.card`，保持 Header（状态 + 启动/停止/保存）与底部「最近运行日志」全宽卡不变。
- **中间配置区建议分块**（可按实现复杂度调整）：
  1. **全局设置**（一卡）：每轮间隔秒、登录等待秒、最大重试等（与行业无关）。
  2. **时间区间**（一卡）：列表/表格展示「开始–结束」区间 → 绑定行业；支持增删改；左闭右开、本地时区可在 hint 中说明。
  3. **行业与任务链**（一卡或可折叠多卡）：行业列表（每项：名称/ID、Notion URL、每 N 次新会话、每 M 次换模型）；点击某行业后展开或进入其**任务链**编辑（任务顺序、每任务输入内容、执行次数）。若行业较多，可采用「左侧行业列表 + 右侧当前行业详情+任务链」或手风琴折叠。
- **实现时**：仍可在 `server.ts` 内联 HTML，或抽成模板/组件；分块逻辑与现有「运行设置 / 文案设置」类似，按配置结构拆成多个 form 或 section 绑定到同一份 schedule 配置即可。

### 已确认：行业列表 + 编辑弹窗 + 时间区间同步（Explore 结论）

以下为与产品确认后的交互与数据规则，实现时按此执行。

- **行业主视图**：**列表行**，每行仅展示「名称（id）」「Notion URL」+ **编辑** 按钮；不在此处展示 N/M、任务链。点击 **编辑** 后打开**弹窗或侧边栏**，在弹窗/侧栏内编辑该行业的 id、notionUrl、newChatEveryRuns、modelSwitchInterval、任务链（增删改任务 content/runCount）。
- **时间区间**：行业选择保持**下拉框**。下拉选项 = 当前行业列表（名称/id）+ **「+ 新建行业」**。选择「+ 新建行业」时：在 `schedule.industries` 中新增一条（占位 id 如 `new_xxx`、空 URL），当前时间区间行的选中值设为该新行业，并**自动打开该新行业的编辑弹窗/侧栏**。
- **任务链**：仅在**编辑弹窗/侧栏**内展示与编辑，主列表不展示任务链。
- **同步**：  
  - 行业 **id 重命名**：在编辑弹窗内保存时，若 id 发生变更，将内存中所有 `timeSlots[].industryId === 旧id` 的项改为新 id，再调用 `renderTimeSlots(schedule)`，保证时间区间下拉的选中值与选项一致。  
  - 行业**新增/删除**：新增后下拉选项多一项；删除某行业时，所有引用该行业的 timeSlot 的 industryId 需清空或改为当前列表第一项（或占位「请选择」），再重绘时间区间。
- **数据源**：时间区间与行业列表共用同一份 `schedule` 对象；任何对 `schedule.industries` 或 `schedule.timeSlots` 的变更后，凡依赖行业列表的 UI（时间区间下拉、行业列表行）均需重绘以保持同步。
